---
title: TMDL Parser
description: Understanding the TMDL format and parser capabilities
sidebar:
  order: 1
---

## What is TMDL?

**Tabular Model Definition Language (TMDL)** is a tab-indented text format used in Power BI PBIP (Power BI Project) files to define semantic models. When you save a Power BI project in PBIP format, the entire semantic model -- tables, measures, relationships, expressions, roles, and more -- is serialized into human-readable `.tmdl` files.

TMDL uses indentation (tabs) to express hierarchy rather than braces or XML tags, making it concise and diff-friendly for version control.

## File Types

A PBIP semantic model directory contains several categories of `.tmdl` files:

| File                 | Purpose                                                          |
| -------------------- | ---------------------------------------------------------------- |
| `database.tmdl`      | Compatibility level, database ID, culture setting                |
| `model.tmdl`         | Top-level model properties, data access options, query groups    |
| `tables/*.tmdl`      | One file per table -- columns, measures, partitions, hierarchies |
| `relationships.tmdl` | All inter-table relationships in one file                        |
| `expressions.tmdl`   | M-code parameters, shared functions, query groups                |
| `cultures/*.tmdl`    | Locale-specific linguistic metadata (e.g., `en-AU.tmdl`)         |
| `roles/*.tmdl`       | Row-Level Security roles with table permission DAX filters       |

The `@pbip-tools/tmdl-parser` package can parse **all** of these file types and serialize them back.

## Parser Capabilities

### Database and Model

The parser extracts top-level metadata from `database.tmdl` and `model.tmdl`:

- **Compatibility level** (e.g., 1604)
- **Default culture** (e.g., `en-AU`)
- **Data access options** and query groups
- **Annotations** attached to the model or database

### Tables

Each `tables/*.tmdl` file is parsed into a structured representation containing:

- **Columns** -- with full property support:
  - `isKey` for key columns
  - `sortByColumn` for display-order overrides
  - Data categories (e.g., `City`, `WebUrl`, `ImageUrl`)
  - Data types, format strings, summarization
- **Measures** -- including DAX expressions (see below)
- **Partitions** -- M-code source queries with mode (import/directQuery)
- **Hierarchies** -- multi-level hierarchies with ordered levels
- **Annotations** and **extended properties**

### Measures and DAX Expression Forms

TMDL supports three distinct syntaxes for DAX expressions, and the parser handles all three:

**1. Inline (single-line)**

```
measure 'Total Revenue' = SUM(Sales[Revenue])
```

**2. Multi-line indent-based**

```
measure 'Revenue YoY %' =
    VAR CurrentYear = [Total Revenue]
    VAR PriorYear = CALCULATE([Total Revenue], SAMEPERIODLASTYEAR('Date'[Date]))
    RETURN
        DIVIDE(CurrentYear - PriorYear, PriorYear)
```

**3. Backtick-delimited**

````
measure 'Complex Measure' = ```
    VAR _Result =
        CALCULATE(
            [Base Measure],
            FILTER(ALL('Table'), 'Table'[Column] = "Value")
        )
    RETURN _Result
    ```
````

Each measure also captures optional properties: `formatString`, `displayFolder`, `description` (via `///` doc comments), and annotations.

### Calculation Groups

The parser supports calculation group tables, including:

- **Precedence** values for evaluation order
- **Calculation items** with their DAX expressions
- **Format string expressions** (`formatStringExpression`) on calculation items

### Relationships

Relationship definitions come in two naming conventions, both supported:

- **GUID-named**: `relationship 3a7b2c1d-...` (auto-generated by Power BI)
- **Descriptive-named**: `relationship 'Sales to Date'`

Parsed properties include:

- From/to table and column references
- Cardinality (one-to-many, many-to-many)
- Cross-filter direction, including `bothDirections`
- `isActive: false` for inactive relationships
- Security filter behavior

### Expressions

The `expressions.tmdl` file contains M-code shared across the model:

- **Parameters** identified by `meta [IsParameterQuery=true, ...]`
- **Shared functions** and reusable M queries
- **Query groups** for organizational structure in Power Query editor

### Cultures

Culture files (e.g., `cultures/en-AU.tmdl`) contain `linguisticMetadata` -- a JSON blob that Power BI uses for Q&A natural language understanding. The parser captures the full JSON content.

### Roles

Row-Level Security (RLS) role files include:

- Role name and `modelPermission` (read, readRefresh, etc.)
- **Table permissions** with DAX filter expressions
- **Members** (user/group references)

## Forward Compatibility

The parser is designed to be resilient against TMDL format evolution. Any **unknown keywords** or properties encountered during parsing are captured as `UnknownNode` objects in the parse tree. The parser **never throws** on unrecognized syntax -- it preserves the content so it can be round-tripped back to disk without data loss.

This means the parser will continue to work correctly even when Microsoft adds new TMDL properties or keywords in future Power BI releases.

## Programmatic Usage

### Parsing

```typescript
import { parseTmdl } from '@pbip-tools/tmdl-parser';

// Parse a table file
const tableContent = await fs.readFile('Sales.tmdl', 'utf-8');
const result = parseTmdl(tableContent, 'table');

// Access parsed data
console.log(result.table.name); // "Sales"
console.log(result.table.measures); // TmdlMeasure[]
console.log(result.table.columns); // TmdlColumn[]
```

File type detection is also available:

```typescript
import { detectFileType } from '@pbip-tools/tmdl-parser';

const fileType = detectFileType(content);
// Returns: 'database' | 'model' | 'table' | 'relationships' | 'expressions' | 'culture' | 'role'
```

For lower-level access, the tokenizer is exposed:

```typescript
import { tokenize } from '@pbip-tools/tmdl-parser';

const tokens = tokenize(content);
// Token[] with type, value, line, indent level
```

### Serialization

The parser includes a full serializer for round-trip editing. After modifying the parsed data structures, serialize them back to valid TMDL:

```typescript
import { serializeTable, serializeRole } from '@pbip-tools/tmdl-parser';

// Modify the parsed table
result.table.measures.push(newMeasure);

// Serialize back to TMDL text
const tmdlText = serializeTable(result.table);
await fs.writeFile('Sales.tmdl', tmdlText);
```

Available serializers:

- `serializeDatabase()` -- database.tmdl
- `serializeModel()` -- model.tmdl
- `serializeTable()` -- tables/\*.tmdl
- `serializeRelationships()` -- relationships.tmdl
- `serializeExpressions()` -- expressions.tmdl
- `serializeCulture()` -- cultures/\*.tmdl
- `serializeRole()` -- roles/\*.tmdl

Each serializer produces TMDL text that is byte-for-byte compatible with Power BI Desktop's own serialization, ensuring clean diffs in version control.
